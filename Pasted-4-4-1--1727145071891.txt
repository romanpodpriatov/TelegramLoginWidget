4. Потоки Работы и Взаимодействия
4.1. Регистрация и Аутентификация
Регистрация:
Пользователь переходит на страницу /login и инициирует процесс аутентификации через Telegram.
После успешной авторизации через Telegram данные пользователя сохраняются в базе данных (users и subscribers).
Аутентификация:
Пользователь использует Telegram Login Widget или аналогичный механизм для входа в веб-приложение.
После успешного входа пользователю предоставляется доступ к личному кабинету.
4.2. Покупка Звёзд XTR
Веб-интерфейс:
Пользователь переходит на страницу /buy_stars и выбирает количество звёзд для покупки.
Веб-интерфейс информирует пользователя перейти в Telegram для завершения покупки.
Telegram-бот:
Пользователь отправляет команду /buy_stars боту.
Бот запрашивает количество звёзд для покупки.
Пользователь вводит желаемое количество.
Бот рассчитывает сумму к оплате на основе курса XTR.
Бот инициирует процесс платежа через Telegram Payments API, отправляя инлайн-кнопку для оплаты.
Пользователь подтверждает платеж.
Обработка Платежей:
Pre-Checkout Query Handler проверяет детали платежа перед его завершением.
Successful Payment Handler обрабатывает успешные платежи, обновляет баланс звёзд пользователя и сохраняет информацию о платеже в таблице payments.
Бот уведомляет пользователя о пополнении баланса.
Взаимодействие с Веб-приложением:
После успешного платежа Telegram-бот отправляет запрос к Flask веб-приложению через API для обновления баланса пользователя и записи платежа.
4.3. Оплата Подписки
Веб-интерфейс:
Пользователь переходит на страницу /subscribe и инициирует оплату подписки за 100 звёзд XTR.
Веб-интерфейс проверяет баланс пользователя и списывает необходимое количество звёзд.
Статус подписки обновляется в базе данных.
Пользователь уведомляется о успешном продлении подписки.
4.4. Создание Аукциона
Веб-интерфейс:
Пользователь с активной подпиской переходит на страницу /new_auction.
Заполняет форму с названием, описанием, стартовой ценой, длительностью и загружает изображение аукциона.
После отправки формы аукцион сохраняется в базе данных и планируется завершение через планировщик задач (APScheduler).
Планировщик Задач:
По истечении времени аукциона функция finish_auction завершает аукцион, определяет победителя и отправляет уведомления через Telegram-бота.
4.5. Участие в Аукционе и Ставки
Веб-интерфейс:
Пользователь просматривает активные аукционы на главной странице.
Переходит на страницу конкретного аукциона /auction/<auction_uuid>.
Делает ставку, заполняя форму с суммой ставки.
После успешной ставки ставка сохраняется в базе данных, текущая цена аукциона обновляется, и создатель аукциона уведомляется через бота.
Telegram-бот:
Получает уведомление о новой ставке и отправляет соответствующее сообщение создателю аукциона.
